--- backup/_callers.py
+++ refactored/_callers.py
@@ -56,0 +57,39 @@
+def_strategy_hookwrapper(
+hook_impl:HookImpl,
+hook_name:str,
+args:Sequence[object],
+teardowns:list[Teardown]
+)->None:
+function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
+next(function_gen)
+teardowns.append(function_gen)
+def_strategy_wrapper(
+hook_impl:HookImpl,
+hook_name:str,
+args:Sequence[object],
+teardowns:list[Teardown]
+)->None:
+try:
+res=hook_impl.function(*args)
+function_gen=cast(Generator[None,object,object],res)
+next(function_gen)
+teardowns.append(function_gen)
+exceptStopIteration:
+_raise_wrapfail(function_gen,"didnotyield")
+def_strategy_regular(
+hook_impl:HookImpl,
+hook_name:str,
+args:Sequence[object],
+results:list[object],
+firstresult:bool
+)->None:
+res=hook_impl.function(*args)
+ifresisnotNone:
+results.append(res)
+iffirstresult:
+raiseStopIteration
+STRATEGIES={
+"hookwrapper":_strategy_hookwrapper,
+"wrapper":_strategy_wrapper,
+"regular":_strategy_regular
+}
@@ -79,3 +118 @@
-function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
-next(function_gen)
-teardowns.append(function_gen)
+strategy=STRATEGIES["hookwrapper"]
@@ -82,0 +120,3 @@
+strategy=STRATEGIES["wrapper"]
+else:
+strategy=STRATEGIES["regular"]
@@ -84,4 +124,8 @@
-res=hook_impl.function(*args)
-function_gen=cast(Generator[None,object,object],res)
-next(function_gen)
-teardowns.append(function_gen)
+strategy(
+hook_impl=hook_impl,
+hook_name=hook_name,
+args=args,
+teardowns=teardowns,
+results=results,
+firstresult=firstresult
+)
@@ -89,6 +132,0 @@
-_raise_wrapfail(function_gen,"didnotyield")
-else:
-res=hook_impl.function(*args)
-ifresisnotNone:
-results.append(res)
-iffirstresult: