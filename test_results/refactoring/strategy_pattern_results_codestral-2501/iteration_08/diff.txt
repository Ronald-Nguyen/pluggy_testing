--- backup/_callers.py
+++ refactored/_callers.py
@@ -56,0 +57,23 @@
+def_strategy_hookwrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->Teardown:
+function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
+next(function_gen)
+returnfunction_gen
+def_strategy_wrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->Teardown:
+try:
+res=hook_impl.function(*args)
+function_gen=cast(Generator[None,object,object],res)
+next(function_gen)
+returnfunction_gen
+exceptStopIteration:
+_raise_wrapfail(function_gen,"didnotyield")
+def_strategy_regular(hook_impl:HookImpl,hook_name:str,args:Sequence[object],results:list[object],firstresult:bool)->None:
+res=hook_impl.function(*args)
+ifresisnotNone:
+results.append(res)
+iffirstresult:
+raiseStopIteration
+STRATEGIES={
+'hookwrapper':_strategy_hookwrapper,
+'wrapper':_strategy_wrapper,
+'regular':_strategy_regular
+}
@@ -79,3 +102,2 @@
-function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
-next(function_gen)
-teardowns.append(function_gen)
+strategy=STRATEGIES['hookwrapper']
+teardowns.append(strategy(hook_impl,hook_name,args))
@@ -82,0 +105,4 @@
+strategy=STRATEGIES['wrapper']
+teardowns.append(strategy(hook_impl,hook_name,args))
+else:
+strategy=STRATEGIES['regular']
@@ -84,4 +110 @@
-res=hook_impl.function(*args)
-function_gen=cast(Generator[None,object,object],res)
-next(function_gen)
-teardowns.append(function_gen)
+strategy(hook_impl,hook_name,args,results,firstresult)
@@ -89,6 +111,0 @@
-_raise_wrapfail(function_gen,"didnotyield")
-else:
-res=hook_impl.function(*args)
-ifresisnotNone:
-results.append(res)
-iffirstresult: