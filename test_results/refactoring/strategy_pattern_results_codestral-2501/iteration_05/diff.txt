--- backup/_callers.py
+++ refactored/_callers.py
@@ -14,3 +14 @@
-defrun_old_style_hookwrapper(
-hook_impl:HookImpl,hook_name:str,args:Sequence[object]
-)->Teardown:
+def_strategy_hookwrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->Teardown:
@@ -38,0 +37,21 @@
+def_strategy_wrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->Teardown:
+try:
+res=hook_impl.function(*args)
+function_gen=cast(Generator[None,object,object],res)
+next(function_gen)
+returnfunction_gen
+exceptStopIteration:
+_raise_wrapfail(function_gen,"didnotyield")
+def_strategy_regular(hook_impl:HookImpl,args:Sequence[object],results:list[object])->None:
+res=hook_impl.function(*args)
+ifresisnotNone:
+results.append(res)
+STRATEGIES={
+"hookwrapper":_strategy_hookwrapper,
+"wrapper":_strategy_wrapper,
+"regular":_strategy_regular,
+}
+defrun_old_style_hookwrapper(
+hook_impl:HookImpl,hook_name:str,args:Sequence[object]
+)->Teardown:
+returnSTRATEGIES["hookwrapper"](hook_impl,hook_name,args)
@@ -79,3 +98,2 @@
-function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
-next(function_gen)
-teardowns.append(function_gen)
+teardown=STRATEGIES["hookwrapper"](hook_impl,hook_name,args)
+teardowns.append(teardown)
@@ -83,7 +101,2 @@
-try:
-res=hook_impl.function(*args)
-function_gen=cast(Generator[None,object,object],res)
-next(function_gen)
-teardowns.append(function_gen)
-exceptStopIteration:
-_raise_wrapfail(function_gen,"didnotyield")
+teardown=STRATEGIES["wrapper"](hook_impl,hook_name,args)
+teardowns.append(teardown)
@@ -91,4 +104,2 @@
-res=hook_impl.function(*args)
-ifresisnotNone:
-results.append(res)
-iffirstresult:
+STRATEGIES["regular"](hook_impl,args,results)
+iffirstresultandresults: