--- backup/_callers.py
+++ refactored/_callers.py
@@ -56,0 +57,23 @@
+def_strategy_hookwrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object],teardowns:list[Teardown])->None:
+function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
+next(function_gen)
+teardowns.append(function_gen)
+def_strategy_wrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object],teardowns:list[Teardown])->None:
+try:
+res=hook_impl.function(*args)
+function_gen=cast(Generator[None,object,object],res)
+next(function_gen)
+teardowns.append(function_gen)
+exceptStopIteration:
+_raise_wrapfail(function_gen,"didnotyield")
+def_strategy_regular(hook_impl:HookImpl,hook_name:str,args:Sequence[object],results:list[object],firstresult:bool)->None:
+res=hook_impl.function(*args)
+ifresisnotNone:
+results.append(res)
+iffirstresult:
+raiseStopIteration()
+STRATEGY_MAP={
+'hookwrapper':_strategy_hookwrapper,
+'wrapper':_strategy_wrapper,
+'regular':_strategy_regular
+}
@@ -78,5 +101 @@
-ifhook_impl.hookwrapper:
-function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
-next(function_gen)
-teardowns.append(function_gen)
-elifhook_impl.wrapper:
+strategy_key='hookwrapper'ifhook_impl.hookwrapperelse'wrapper'ifhook_impl.wrapperelse'regular'
@@ -84,4 +103 @@
-res=hook_impl.function(*args)
-function_gen=cast(Generator[None,object,object],res)
-next(function_gen)
-teardowns.append(function_gen)
+STRATEGY_MAP[strategy_key](hook_impl,hook_name,args,teardowns,results,firstresult)
@@ -89,6 +104,0 @@
-_raise_wrapfail(function_gen,"didnotyield")
-else:
-res=hook_impl.function(*args)
-ifresisnotNone:
-results.append(res)
-iffirstresult: