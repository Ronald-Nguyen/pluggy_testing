--- backup/_callers.py
+++ refactored/_callers.py
@@ -13,0 +14,22 @@
+def_strategy_hookwrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->Teardown:
+teardown:Teardown=cast(Teardown,hook_impl.function(*args))
+try:
+next(teardown)
+exceptStopIteration:
+_raise_wrapfail(teardown,"didnotyield")
+returnteardown
+def_strategy_wrapper(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->Teardown:
+try:
+res=hook_impl.function(*args)
+function_gen=cast(Generator[None,object,object],res)
+next(function_gen)
+returnfunction_gen
+exceptStopIteration:
+_raise_wrapfail(function_gen,"didnotyield")
+def_strategy_regular(hook_impl:HookImpl,hook_name:str,args:Sequence[object])->object:
+returnhook_impl.function(*args)
+HOOK_STRATEGIES={
+'hookwrapper':_strategy_hookwrapper,
+'wrapper':_strategy_wrapper,
+'regular':_strategy_regular
+}
@@ -79,3 +101 @@
-function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
-next(function_gen)
-teardowns.append(function_gen)
+strategy=HOOK_STRATEGIES['hookwrapper']
@@ -83,7 +103 @@
-try:
-res=hook_impl.function(*args)
-function_gen=cast(Generator[None,object,object],res)
-next(function_gen)
-teardowns.append(function_gen)
-exceptStopIteration:
-_raise_wrapfail(function_gen,"didnotyield")
+strategy=HOOK_STRATEGIES['wrapper']
@@ -91,3 +105,7 @@
-res=hook_impl.function(*args)
-ifresisnotNone:
-results.append(res)
+strategy=HOOK_STRATEGIES['regular']
+result=strategy(hook_impl,hook_name,args)
+ifhook_impl.hookwrapperorhook_impl.wrapper:
+teardowns.append(result)
+else:
+ifresultisnotNone:
+results.append(result)