--- backup/_callers.py
+++ refactored/_callers.py
@@ -56,0 +57,60 @@
+def_get_args(hook_impl:HookImpl,caller_kwargs:Mapping[str,object])->list[object]:
+try:
+return[caller_kwargs[argname]forargnameinhook_impl.argnames]
+exceptKeyErrorase:
+forargnameinhook_impl.argnames:
+ifargnamenotincaller_kwargs:
+raiseHookCallError(
+f"hookcallmustprovideargument{argname!r}"
+)frome
+return[]
+def_strategy_hookwrapper(
+hook_impl:HookImpl,
+hook_name:str,
+caller_kwargs:Mapping[str,object],
+teardowns:list[Teardown],
+results:list[object],
+firstresult:bool,
+)->bool:
+args=_get_args(hook_impl,caller_kwargs)
+function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
+next(function_gen)
+teardowns.append(function_gen)
+returnFalse
+def_strategy_wrapper(
+hook_impl:HookImpl,
+hook_name:str,
+caller_kwargs:Mapping[str,object],
+teardowns:list[Teardown],
+results:list[object],
+firstresult:bool,
+)->bool:
+args=_get_args(hook_impl,caller_kwargs)
+try:
+res=hook_impl.function(*args)
+function_gen=cast(Generator[None,object,object],res)
+next(function_gen)
+teardowns.append(function_gen)
+exceptStopIteration:
+_raise_wrapfail(function_gen,"didnotyield")
+returnFalse
+def_strategy_standard(
+hook_impl:HookImpl,
+hook_name:str,
+caller_kwargs:Mapping[str,object],
+teardowns:list[Teardown],
+results:list[object],
+firstresult:bool,
+)->bool:
+args=_get_args(hook_impl,caller_kwargs)
+res=hook_impl.function(*args)
+ifresisnotNone:
+results.append(res)
+iffirstresult:
+returnTrue
+returnFalse
+STRATEGIES={
+(True,False):_strategy_hookwrapper,
+(False,True):_strategy_wrapper,
+(False,False):_strategy_standard,
+}
@@ -70,25 +130,5 @@
-try:
-args=[caller_kwargs[argname]forargnameinhook_impl.argnames]
-exceptKeyErrorase:
-forargnameinhook_impl.argnames:
-ifargnamenotincaller_kwargs:
-raiseHookCallError(
-f"hookcallmustprovideargument{argname!r}"
-)frome
-ifhook_impl.hookwrapper:
-function_gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
-next(function_gen)
-teardowns.append(function_gen)
-elifhook_impl.wrapper:
-try:
-res=hook_impl.function(*args)
-function_gen=cast(Generator[None,object,object],res)
-next(function_gen)
-teardowns.append(function_gen)
-exceptStopIteration:
-_raise_wrapfail(function_gen,"didnotyield")
-else:
-res=hook_impl.function(*args)
-ifresisnotNone:
-results.append(res)
-iffirstresult:
+strategy=STRATEGIES[(hook_impl.hookwrapper,hook_impl.wrapper)]
+should_break=strategy(
+hook_impl,hook_name,caller_kwargs,teardowns,results,firstresult
+)
+ifshould_break: