--- backup/_hooks.py
+++ refactored/_hooks.py
@@ -256,6 +256 @@
-fori,methodinenumerate(self._hookimpls):
-ifmethod.hookwrapperormethod.wrapper:
-splitpoint=i
-break
-else:
-splitpoint=len(self._hookimpls)
+splitpoint=self._find_wrapper_splitpoint()
@@ -270,0 +266,9 @@
+self._insert_hookimpl_default(hookimpl,start,end)
+def_find_wrapper_splitpoint(self)->int:
+fori,methodinenumerate(self._hookimpls):
+ifmethod.hookwrapperormethod.wrapper:
+returni
+returnlen(self._hookimpls)
+def_insert_hookimpl_default(
+self,hookimpl:HookImpl,start:int,end:int
+)->None:

--- backup/_manager.py
+++ refactored/_manager.py
@@ -88,0 +89,3 @@
+self._register_plugin_hooks(plugin,plugin_name)
+returnplugin_name
+def_register_plugin_hooks(self,plugin:_Plugin,plugin_name:str)->None:
@@ -91,0 +95,8 @@
+self._register_hookimpl(plugin,plugin_name,name,hookimpl_opts)
+def_register_hookimpl(
+self,
+plugin:_Plugin,
+plugin_name:str,
+name:str,
+hookimpl_opts:HookimplOpts,
+)->None:
@@ -104 +114,0 @@
-returnplugin_name

--- backup/pluggy\_callers.py
+++ refactored/pluggy\_callers.py
@@ -0,0 +1,152 @@
+from__future__importannotations
+fromcollections.abcimportGenerator
+fromcollections.abcimportMapping
+fromcollections.abcimportSequence
+fromtypingimportcast
+fromtypingimportNoReturn
+fromtypingimportTypeAlias
+importwarnings
+from._hooksimportHookImpl
+from._resultimportHookCallError
+from._resultimportResult
+from._warningsimportPluggyTeardownRaisedWarning
+Teardown:TypeAlias=Generator[None,object,object]
+defrun_old_style_hookwrapper(
+hook_impl:HookImpl,hook_name:str,args:Sequence[object]
+)->Teardown:
+teardown:Teardown=cast(Teardown,hook_impl.function(*args))
+try:
+next(teardown)
+exceptStopIteration:
+_raise_wrapfail(teardown,"didnotyield")
+try:
+res=yield
+result=Result(res,None)
+exceptBaseExceptionasexc:
+result=Result(None,exc)
+try:
+teardown.send(result)
+exceptStopIteration:
+pass
+exceptBaseExceptionase:
+_warn_teardown_exception(hook_name,hook_impl,e)
+raise
+else:
+_raise_wrapfail(teardown,"hassecondyield")
+finally:
+teardown.close()
+returnresult.get_result()
+def_raise_wrapfail(
+wrap_controller:Generator[None,object,object],
+msg:str,
+)->NoReturn:
+co=wrap_controller.gi_code
+raiseRuntimeError(
+f"wrap_controllerat{co.co_name!r}{co.co_filename}:{co.co_firstlineno}{msg}"
+)
+def_warn_teardown_exception(
+hook_name:str,hook_impl:HookImpl,e:BaseException
+)->None:
+msg=(
+f"Apluginraisedanexceptionduringanold-stylehookwrapperteardown.\n"
+f"Plugin:{hook_impl.plugin_name},Hook:{hook_name}\n"
+f"{type(e).__name__}:{e}\n"
+f"Formoreinformationseehttps://pluggy.readthedocs.io/en/stable/api_reference.html#pluggy.PluggyTeardownRaisedWarning"
+)
+warnings.warn(PluggyTeardownRaisedWarning(msg),stacklevel=6)
+def_multicall(
+hook_name:str,
+hook_impls:Sequence[HookImpl],
+caller_kwargs:Mapping[str,object],
+firstresult:bool,
+)->object|list[object]:
+__tracebackhide__=True
+results:list[object]=[]
+exception=None
+teardowns:list[Teardown]=[]
+try:
+_exec_hook_impls(
+hook_name,hook_impls,caller_kwargs,firstresult,results,teardowns
+)
+exceptBaseExceptionasexc:
+exception=exc
+iffirstresult:
+outcome=results[0]ifresultselseNone
+else:
+outcome=results
+return_process_teardowns(teardowns,outcome,exception)
+def_exec_hook_impls(
+hook_name:str,
+hook_impls:Sequence[HookImpl],
+caller_kwargs:Mapping[str,object],
+firstresult:bool,
+results:list[object],
+teardowns:list[Teardown],
+)->None:
+__tracebackhide__=True
+forhook_implinreversed(hook_impls):
+args=_make_args(hook_impl,caller_kwargs)
+ifhook_impl.hookwrapper:
+gen=run_old_style_hookwrapper(hook_impl,hook_name,args)
+next(gen)
+teardowns.append(gen)
+elifhook_impl.wrapper:
+res=hook_impl.function(*args)
+gen=cast(Generator[None,object,object],res)
+try:
+next(gen)
+exceptStopIteration:
+_raise_wrapfail(gen,"didnotyield")
+teardowns.append(gen)
+else:
+res=hook_impl.function(*args)
+ifresisnotNone:
+results.append(res)
+iffirstresult:
+break
+def_make_args(
+hook_impl:HookImpl,caller_kwargs:Mapping[str,object]
+)->list[object]:
+__tracebackhide__=True
+try:
+return[caller_kwargs[argname]forargnameinhook_impl.argnames]
+exceptKeyErrorase:
+forargnameinhook_impl.argnames:
+ifargnamenotincaller_kwargs:
+raiseHookCallError(
+f"hookcallmustprovideargument{argname!r}"
+)frome
+raise
+def_process_teardowns(
+teardowns:list[Teardown],outcome:object,exception:BaseException|None
+)->object:
+__tracebackhide__=True
+forteardowninreversed(teardowns):
+try:
+ifexceptionisnotNone:
+ifnot_teardown_throw(teardown,exception):
+continue
+else:
+teardown.send(outcome)
+teardown.close()
+exceptStopIterationassi:
+outcome=si.value
+exception=None
+continue
+exceptBaseExceptionase:
+exception=e
+continue
+_raise_wrapfail(teardown,"hassecondyield")
+ifexceptionisnotNone:
+raiseexception
+returnoutcome
+def_teardown_throw(teardown:Teardown,exception:BaseException)->bool:
+__tracebackhide__=True
+try:
+teardown.throw(exception)
+returnTrue
+exceptRuntimeErrorasre:
+ifisinstance(exception,StopIteration)andre.__cause__isexception:
+teardown.close()
+returnFalse
+raise